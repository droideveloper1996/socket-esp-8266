<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />

    <!-- Optional theme -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
      integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
      crossorigin="anonymous"
    />

    <!-- Latest compiled and minified JavaScript -->
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
      integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <title>deX Esp Data Collection</title>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">
            deX IoT
          </a>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div id="light" class="alert alert-success">Unknown</div>
        <h4>Trigger Actions</h4>

        <button class="btn btn-primary" id="basant">Basant</button>
        <button class="btn btn-alert" id="toggleButton">Toggle</button>

        <button class="btn btn-danger" id="clearLogs">
          Clear Server Logs
        </button>
      </div>
      <div class="row">
        <div class="col-sm-6">
          <canvas id="myChart1" width="400" height="400"></canvas>
          <canvas id="myChart2" width="400" height="400"></canvas>
        </div>
        <div class="col-sm-6">
          <div class="jumbotron alert alert-info">
            <h2>Data From Logs</h2>
            <div style="overflow:scroll; height:400px;"  id="dataset"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>

    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      const btnBasant = document.getElementById("basant");
      var ctx1 = document.getElementById("myChart1").getContext("2d");
      var ctx2 = document.getElementById("myChart2").getContext("2d");
      const clearLogs = document.getElementById("clearLogs");
      const dataset = document.getElementById("dataset");
      const socket = io("http://13.232.193.81:3000/");
//      const socket = io("http://localhost:4000/");

      $("#toggleButton").on("click", function () {
        socket.emit("toggle", { state: true });
      });
      socket.on("light", function (light) {
        console.log(light);
        if (light.state) {
          $("#light").text("ON");
        } else {
          $("#light").text("off");
        }

        btnBasant.onclick = () => {
       //   const payload = `apiKey: esp8266,temp: ${Math.floor(
          //  Math.random() * 100
         // )},humidity: ${Math.floor(Math.random() * 100)}`;
         // socket.emit("basant", payload);
        };
      });
      clearLogs.onclick = () => {
        socket.emit("clearLogs", { apiKey: "esp8266" });
      };

      var xLabel = [];
      var yLabel = [];
      var _x_data = [];
	
      socket.on("track-live", (data) => {
	//console.log(data);
	data.reverse();
        dataset.innerText = data;
        for (let i = 0; i <10; i++) {
          const item = JSON.parse(data[i]);
          xLabel[i] = parseInt(item.humidity);
          yLabel[i] = parseInt(item.temp);
          _x_data[i]=i;
          
        }
        //console.log("yLabel",yLabel);
        //console.log("xLabel",xLabel);
        //console.log("_x_data",_x_data);
        drawChart(yLabel,_x_data ,ctx1, "Temperature");
        drawChart(xLabel,_x_data,ctx2, "Humidity");
      });
       
      drawChart = (trainData, _Xdata,ctx, label) => {
        var myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [1,2,3,4,5,6,7,8,9,10],
            datasets: [
              {
                label: label,
                data: trainData,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.2)",
                  "rgba(54, 162, 235, 0.2)",
                  "rgba(255, 206, 86, 0.2)",
                  "rgba(75, 192, 192, 0.2)",
                  "rgba(153, 102, 255, 0.2)",
                  "rgba(255, 159, 64, 0.2)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                  "rgba(255, 159, 64, 1)",
                ],
                borderWidth: 1.5,
              },
            ],
          },
          options: {
            scales: {
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
            },
          },
        });
      };
    </script>
  </body>
</html>
